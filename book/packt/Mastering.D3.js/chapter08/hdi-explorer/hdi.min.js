var hdi={};hdi.chart={},hdi.chart.trend=function(){"use strict";function chart(selection){selection.each(function(data){var div=d3.select(this),svg=div.selectAll("svg").data([data]),margin=chart.margin(),width=chart.width()-margin.left-margin.right,height=chart.height()-margin.top-margin.bottom;svg.enter().append("svg").call(chart.svgInit);var gchart=svg.select("g.chart"),gphantom=svg.select("g.chart-phantom"),items=d3.merge(data.map(attributes.series)),xScale=d3.scale.linear().domain(d3.extent(items,function(d){return attributes.x(d)})).range([0,width]),yScale=d3.scale.linear().domain([0,1]).range([height,0]),line=d3.svg.line().x(function(d){return xScale(attributes.x(d))}).y(function(d){return yScale(attributes.y(d))}),lines=gchart.selectAll("path").data(data),ghost=gphantom.selectAll("path").data(data);lines.enter().append("path").attr("d",function(d){return line(attributes.series(d))}).classed("trend-path",!0),ghost.enter().append("path").attr("d",function(d){return line(attributes.series(d))}).classed("trend-phantom",!0),ghost.classed("trend-highlight",function(d){return d.selected});var xAxis=d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("d"));svg.select("g.xaxis").call(xAxis);var yAxis=d3.svg.axis().scale(yScale).orient("left");svg.select("g.yaxis").call(yAxis),svg.select("g.xaxis").selectAll("g.tick").select("line").style("stroke","white").attr("y2",6).attr("y1",-height)})}function createAccessor(attr){function accessor(value){return arguments.length?(attributes[attr]=value,chart):attributes[attr]}return accessor}var attributes={width:600,height:400,margin:{top:20,right:20,bottom:20,left:40},series:function(d){return d.series},x:function(d){return d.x},y:function(d){return d.y}};chart.svgInit=function(svg){var margin=chart.margin(),width=chart.width()-margin.left-margin.right,height=chart.height()-margin.top-margin.bottom;svg.attr("width",chart.width()).attr("height",chart.height()),svg.append("g").attr("class","chart-background").attr("transform","translate("+[margin.left,margin.top]+")").append("rect").attr("class","chart-background").attr("width",width).attr("height",height),svg.append("g").attr("class","chart").attr("transform","translate("+[margin.left,margin.top]+")"),svg.append("g").attr("class","chart-phantom").attr("transform","translate("+[margin.left,margin.top]+")"),svg.append("g").attr("class","axis xaxis").attr("transform","translate("+[margin.left,margin.top+height]+")"),svg.append("g").attr("class","axis yaxis").attr("transform","translate("+[margin.left,margin.top]+")")};for(var attr in attributes)!chart[attr]&&attributes.hasOwnProperty(attr)&&(chart[attr]=createAccessor(attr));return chart};var app={};app.ApplicationModel=Backbone.Model.extend({defaults:{code:""}}),app.CountryInformation=Backbone.Model.extend({url:"",baseurl:"http://data.undp.org/resource/wxub-qc5k.json",urltpl:_.template("<%= baseurl %>?Abbreviation=<%= code %>"),"default":{code:"",name:""},setState:function(state){this.url=this.urltpl({baseurl:this.baseurl,code:state.get("code")}),this.fetch({reset:!0})},parse:function(response){var item=response.pop(),data={code:item.abbreviation,name:item.name};for(var attr in item)"_"===attr[0]&&(data[attr.slice(6)]=item[attr]);return data}}),app.CountryTrend=Backbone.Model.extend({defaults:{name:"",code:"",selected:!1,hdiSeries:[]},idAttribute:"code",parse:function(response){var data={code:response.country_code,name:response.country_name,selected:!1,hdiSeries:[]};for(var attr in response){var part=attr.split("_");3===part.length&&"hdi"===part[2]&&data.hdiSeries.push({year:parseInt(part[1],10),hdi:parseFloat(response[attr])})}return data.hdiSeries.sort(function(a,b){return b.year-a.year}),data}}),app.Countries=Backbone.Collection.extend({model:app.CountryTrend,url:"http://data.undp.org/resource/efc4-gjvq.json",parse:function(response){return response.filter(function(d){return d.country_code})},setSelected:function(code){var selected=this.findWhere({selected:!0});selected&&selected.set("selected",!1),selected=this.findWhere({code:code}),selected&&selected.set("selected",!0)}}),app.CountryInformationView=Backbone.View.extend({template:_.template($("#country-summary-template").html()),initialize:function(){this.listenTo(this.model,"change:name",this.render)},render:function(){this.$el.html(this.template(this.model.toJSON()))}}),app.CountriesTrendView=Backbone.View.extend({chart:hdi.chart.trend().series(function(d){return d.hdiSeries}).x(function(d){return d.year}).y(function(d){return d.hdi}),initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"change:selected",this.render)},render:function(){this.chart.width(this.$el.width()),d3.select(this.el).data([this.collection.toJSON()]).call(this.chart)},setState:function(state){this.collection.setSelected(state.get("code"))}}),app.CountriesSearchView=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"reset",this.render)},events:{"typeahead:selected input[type=text]":"setSelected"},render:function(){this.engine=new Bloodhound({datumTokenizer:function(d){return Bloodhound.tokenizers.whitespace(d.name)},queryTokenizer:Bloodhound.tokenizers.whitespace,local:this.collection.toJSON()}),this.engine.initialize(),this.$el.children("#search-country-input").typeahead(null,{displayKey:"name",source:this.engine.ttAdapter()})},setSelected:function(event,datum){this.collection.setSelected(datum.code)}}),app.state=new app.ApplicationModel,app.countries=new app.Countries,app.countries.listenTo(app.state,"change:code",function(state){this.setSelected(state.get("code"))}),app.countries.on({reset:function(){app.state.get("code")||app.state.set("code",this.first().get("code"))},"change:selected":function(){var selected=this.findWhere({selected:!0});selected&&app.state.set("code",selected.get("code"))}}),app.countries.fetch({reset:!0}),app.country=new app.CountryInformation,app.country.listenTo(app.state,"change:code",app.country.setState),app.Router=Backbone.Router.extend({initialize:function(attributes){this.model=attributes.model,this.listenTo(this.model,"change:code",this.setState)},routes:{"country/:code":"setCode"},setCode:function(code){this.model.set({code:code}),this.navigate("country/"+code,{trigger:!0})},setState:function(model){this.setCode(model.get("code"))}}),app.router=new app.Router({model:app.state}),Backbone.history.start(),app.trendView=new app.CountriesTrendView({el:$("div#chart"),collection:app.countries}),app.searchView=new app.CountriesSearchView({el:$("#search-country"),collection:app.countries}),app.infoView=new app.CountryInformationView({el:$("div#table"),model:app.country});